"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_vXETable=require("../../v-x-e-table"),_utils=require("../../tools/utils"),_util=require("../../table/src/util"),_dom=require("../../tools/dom");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,r=1,l=arguments.length;r<l;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},__spreadArray=function(e,t){for(var r=0,l=t.length,n=e.length;r<l;r++,n++)e[n]=t[r];return e},tableEditMethodKeys=["insert","insertAt","remove","removeCheckboxRow","removeRadioRow","removeCurrentRow","getRecordset","getInsertRecords","getRemoveRecords","getUpdateRecords","getActiveRecord","getSelectedCell","clearActived","clearSelected","isActiveByRow","setActiveRow","setActiveCell","setSelectCell"],editHook={setupTable:function(m){var h=m.props,C=m.reactData,p=m.internalData,a=m.getRefMaps().refElem,e=m.getComputeMaps(),s=e.computeMouseOpts,R=e.computeEditOpts,w=e.computeCheckboxOpts,x=e.computeSYOpts,n=e.computeTreeOpts,_={},b={},S=function(e,t){var r=t.model;t.editRender&&(r.value=(0,_util.getCellValue)(e,t),r.update=!1)},u=function(e,t){var r=t.model;t.editRender&&r.update&&((0,_util.setCellValue)(e,t,r.value),r.update=!1,r.value=null)},o=function(){var e=a.value;if(e){var t=e.querySelector(".col--selected");t&&(0,_dom.removeClass)(t,"col--selected")}};function c(){var e=C.editStore,t=C.tableColumn,r=R.value,l=e.actived,n=l.row,o=l.column;(n||o)&&("row"===r.mode?t.forEach(function(e){return u(n,e)}):u(n,o))}return _={insert:function(e){return _.insertAt(e,null)},insertAt:function(e,t){var r,l=h.treeConfig,n=C.mergeList,o=C.editStore,a=C.scrollYLoad,u=p.afterFullData,c=p.tableFullData,i=x.value;_xeUtils.default.isArray(e)||(e=[e]);var d=e.map(function(e){return m.defineField(Object.assign({},e))});if(t)if(-1===t)u.push.apply(u,d),c.push.apply(c,d),n.forEach(function(e){var t=e.row,r=e.rowspan;t+r>u.length&&(e.rowspan=r+d.length)});else{if(l)throw new Error((0,_utils.getLog)("vxe.error.noTree",["insert"]));var s=m.findRowIndexOf(u,t);if(-1===s)throw new Error((0,_utils.errLog)("vxe.error.unableInsert"));u.splice.apply(u,__spreadArray([s,0],d)),c.splice.apply(c,__spreadArray([m.findRowIndexOf(c,t),0],d)),n.forEach(function(e){var t=e.row,r=e.rowspan;s<t?e.row=t+d.length:s<t+r&&(e.rowspan=r+d.length)})}else u.unshift.apply(u,d),c.unshift.apply(c,d),n.forEach(function(e){var t=e.row;0<t&&(e.row=t+d.length)});return(r=o.insertList).unshift.apply(r,d),C.scrollYLoad=!l&&-1<i.gt&&i.gt<c.length,m.updateFooter(),m.updateCache(),m.handleTableData(),m.updateAfterDataIndex(),m.checkSelectionStatus(),a&&m.updateScrollYSpace(),(0,_vue.nextTick)().then(function(){return m.updateCellAreas(),m.recalculate()}).then(function(){return{row:d.length?d[d.length-1]:null,rows:d}})},remove:function(e){var t=h.treeConfig,n=C.mergeList,r=C.editStore,l=C.selection,o=C.scrollYLoad,a=p.afterFullData,u=p.tableFullData,c=w.value,i=x.value,d=r.actived,s=r.removeList,f=r.insertList,v=c.checkField,g=[];return e?_xeUtils.default.isArray(e)||(e=[e]):e=u,e.forEach(function(e){m.isInsertByRow(e)||s.push(e)}),v||e.forEach(function(e){var t=m.findRowIndexOf(l,e);-1<t&&l.splice(t,1)}),u===e?(e=g=u.slice(0),p.tableFullData=[],p.afterFullData=[],m.clearMergeCells()):e.forEach(function(e){var t=m.findRowIndexOf(u,e);if(-1<t){var r=u.splice(t,1);g.push(r[0])}var l=m.findRowIndexOf(a,e);-1<l&&(n.forEach(function(e){var t=e.row,r=e.rowspan;l<t?e.row=t-1:l<t+r&&(e.rowspan=r-1)}),a.splice(l,1))}),d.row&&-1<m.findRowIndexOf(e,d.row)&&_.clearActived(),e.forEach(function(e){var t=m.findRowIndexOf(f,e);-1<t&&f.splice(t,1)}),C.scrollYLoad=!t&&-1<i.gt&&i.gt<u.length,m.updateFooter(),m.updateCache(),m.handleTableData(),m.updateAfterDataIndex(),m.checkSelectionStatus(),o&&m.updateScrollYSpace(),(0,_vue.nextTick)().then(function(){return m.updateCellAreas(),m.recalculate()}).then(function(){return{row:g.length?g[g.length-1]:null,rows:g}})},removeCheckboxRow:function(){return _.remove(m.getCheckboxRecords()).then(function(e){return m.clearCheckboxRow(),e})},removeRadioRow:function(){var e=m.getRadioRecord();return _.remove(e||[]).then(function(e){return m.clearRadioRow(),e})},removeCurrentRow:function(){var e=m.getCurrentRecord();return _.remove(e||[]).then(function(e){return m.clearCurrentRow(),e})},getRecordset:function(){return{insertRecords:_.getInsertRecords(),removeRecords:_.getRemoveRecords(),updateRecords:_.getUpdateRecords()}},getInsertRecords:function(){var e=C.editStore,t=p.tableFullData,r=e.insertList,l=[];return r.length&&t.forEach(function(e){-1<m.findRowIndexOf(r,e)&&l.push(e)}),l},getRemoveRecords:function(){return C.editStore.removeList},getUpdateRecords:function(){var e=h.keepSource,t=h.treeConfig,r=p.tableFullData,l=n.value;return e?(c(),t?_xeUtils.default.filterTree(r,function(e){return m.isUpdateByRow(e)},l):r.filter(function(e){return m.isUpdateByRow(e)})):[]},getActiveRecord:function(){var e=C.editStore,t=p.afterFullData,r=a.value,l=e.actived,n=l.args,o=l.row;return n&&-1<m.findRowIndexOf(t,o)&&r.querySelectorAll(".vxe-body--column.col--actived").length?Object.assign({},n):null},getSelectedCell:function(){var e=C.editStore.selected,t=e.args,r=e.column;return t&&r?Object.assign({},t):null},clearActived:function(e){var t=C.editStore.actived,r=t.row,l=t.column;return(r||l)&&(c(),t.args=null,t.row=null,t.column=null,m.updateFooter(),m.dispatchEvent("edit-closed",{row:r,rowIndex:m.getRowIndex(r),$rowIndex:m.getVMRowIndex(r),column:l,columnIndex:m.getColumnIndex(l),$columnIndex:m.getVMColumnIndex(l)},e||null)),(m.clearValidate?m.clearValidate():(0,_vue.nextTick)()).then(function(){return m.recalculate()})},clearSelected:function(){var e=C.editStore.selected;return e.row=null,e.column=null,o(),(0,_vue.nextTick)()},isActiveByRow:function(e){return C.editStore.actived.row===e},setActiveRow:function(e){var t=p.visibleColumn;return m.setActiveCell(e,_xeUtils.default.find(t,function(e){return(0,_utils.isEnableConf)(e.editRender)}))},setActiveCell:function(t,e){var r=h.editConfig,l=_xeUtils.default.isString(e)?m.getColumnByField(e):e;return t&&l&&(0,_utils.isEnableConf)(r)&&(0,_utils.isEnableConf)(l.editRender)?m.scrollToRow(t,l).then(function(){var e=m.getCell(t,l);return e&&(b.handleActived({row:t,rowIndex:m.getRowIndex(t),column:l,columnIndex:m.getColumnIndex(l),cell:e,$table:m}),p._lastCallTime=Date.now()),(0,_vue.nextTick)()}):(0,_vue.nextTick)()},setSelectCell:function(e,t){var r=C.tableData,l=p.visibleColumn,n=R.value,o=_xeUtils.default.isString(t)?m.getColumnByField(t):t;if(e&&o&&"manual"!==n.trigger){var a=m.findRowIndexOf(r,e);if(-1<a&&o){var u=m.getCell(e,o),c={row:e,rowIndex:a,column:o,columnIndex:l.indexOf(o),cell:u};m.handleSelected(c,{})}}return(0,_vue.nextTick)()}},b={handleActived:function(e,t){var r=h.editConfig,l=h.mouseConfig,n=C.editStore,o=C.tableColumn,a=R.value,u=a.mode,c=a.activeMethod,i=n.actived,d=e.row,s=e.column,f=s.editRender,v=e.cell=e.cell||m.getCell(d,s);if((0,_utils.isEnableConf)(r)&&(0,_utils.isEnableConf)(f)&&v){if(i.row!==d||"cell"===u&&i.column!==s){var g="edit-disabled";c&&!c(e)||(l&&(_.clearSelected(),m.clearCellAreas&&(m.clearCellAreas(),m.clearCopyCellArea())),m.closeTooltip(),_.clearActived(t),g="edit-actived",s.renderHeight=v.offsetHeight,i.args=e,i.row=d,i.column=s,"row"===u?o.forEach(function(e){return S(d,e)}):S(d,s),(0,_vue.nextTick)(function(){b.handleFocus(e,t)})),m.dispatchEvent(g,{row:d,rowIndex:m.getRowIndex(d),$rowIndex:m.getVMRowIndex(d),column:s,columnIndex:m.getColumnIndex(s),$columnIndex:m.getVMColumnIndex(s)},t)}else{var p=i.column;if(l&&(_.clearSelected(),m.clearCellAreas&&(m.clearCellAreas(),m.clearCopyCellArea())),p!==s){var w=p.model;w.update&&(0,_util.setCellValue)(d,p,w.value),m.clearValidate&&m.clearValidate()}s.renderHeight=v.offsetHeight,i.args=e,i.column=s,setTimeout(function(){b.handleFocus(e,t)})}m.focus()}return(0,_vue.nextTick)()},handleFocus:function(e){var t=e.row,r=e.column,l=e.cell,n=r.editRender;if((0,_utils.isEnableConf)(n)){var o=_vXETable.renderer.get(n.name),a=n.autofocus,u=n.autoselect,c=void 0;if(a&&(c=l.querySelector(a)),!c&&o&&o.autofocus&&(c=l.querySelector(o.autofocus)),c){if(c.focus(),u)c.select();else if(_dom.browse.msie){var i=c.createTextRange();i.collapse(!1),i.select()}}else m.scrollToRow(t,r)}},handleSelected:function(e,t){var r=h.mouseConfig,l=C.editStore,n=s.value,o=R.value,a=l.actived,u=l.selected,c=e.row,i=e.column,d=r&&n.selected;return!d||u.row===c&&u.column===i||(a.row!==c||"cell"===o.mode&&a.column!==i)&&(_.clearActived(t),_.clearSelected(),m.clearCellAreas&&(m.clearCellAreas(),m.clearCopyCellArea()),u.args=e,u.row=c,u.column=i,d&&b.addCellSelectedClass(),m.focus()),(0,_vue.nextTick)()},addCellSelectedClass:function(){var e=C.editStore.selected,t=e.row,r=e.column;if(o(),t&&r){var l=m.getCell(t,r);l&&(0,_dom.addClass)(l,"col--selected")}}},__assign(__assign({},_),b)},setupGrid:function(e){return e.extendTableMethods(tableEditMethodKeys)}},_default=editHook;exports.default=_default;