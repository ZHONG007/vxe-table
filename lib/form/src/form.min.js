"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_vXETable=require("../../v-x-e-table"),_utils=require("../../tools/utils"),_dom=require("../../tools/dom"),_util=require("./util"),_render=require("./render"),_size=require("../../hooks/size");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},Rule=function(){function e(e){Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.min,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}return Object.defineProperty(e.prototype,"message",{get:function(){return(0,_utils.getFuncText)(this.$options.message)},enumerable:!1,configurable:!0}),e}(),validErrorRuleValue=function(e,t){var i=e.type,r=e.min,n=e.max,l=e.pattern,u="number"===i,o=u?_xeUtils.default.toNumber(t):_xeUtils.default.getSize(t);return!(!u||!isNaN(t))||(!_xeUtils.default.eqNull(r)&&o<_xeUtils.default.toNumber(r)||(!_xeUtils.default.eqNull(n)&&o>_xeUtils.default.toNumber(n)||!(!l||(_xeUtils.default.isRegExp(l)?l:new RegExp(l)).test(t))))};function getResetValue(e,t){return _xeUtils.default.isArray(e)&&(t=[]),t}var _default2=(0,_vue.defineComponent)({name:"VxeForm",props:{collapseStatus:{type:Boolean,default:!0},loading:Boolean,data:Object,size:{type:String,default:function(){return _conf.default.form.size||_conf.default.size}},span:[String,Number],align:{type:String,default:function(){return _conf.default.form.align}},titleAlign:{type:String,default:function(){return _conf.default.form.titleAlign}},titleWidth:[String,Number],titleColon:{type:Boolean,default:function(){return _conf.default.form.titleColon}},titleAsterisk:{type:Boolean,default:function(){return _conf.default.form.titleAsterisk}},titleOverflow:{type:[Boolean,String],default:null},className:[String,Function],items:Array,rules:Object,preventSubmit:{type:Boolean,default:function(){return _conf.default.form.preventSubmit}},validConfig:Object,tooltipConfig:Object,customLayout:{type:Boolean,default:function(){return _conf.default.form.customLayout}}},emits:["update:collapseStatus","collapse","toggle-collapse","submit","submit-invalid","reset"],setup:function(k,e){var f=_vXETable.VXETable.tooltip,d=e.slots,r=e.emit,t=_xeUtils.default.uniqueId(),v=(0,_size.useSize)(k),m=(0,_vue.reactive)({collapseAll:k.collapseStatus,staticItems:[],formItems:[]}),a=(0,_vue.reactive)({tooltipTimeout:null,tooltipActive:!1,tooltipStore:{item:null,visible:!1}}),p=(0,_vue.ref)(),_=(0,_vue.ref)(),i={},g=(0,_vue.computed)(function(){return Object.assign({},_conf.default.form.validConfig,k.validConfig)}),h=(0,_vue.ref)(),n=function(){var e=h.value;return setTimeout(function(){a.tooltipActive||i.closeTooltip()},e.leaveDelay),!1};h=(0,_vue.computed)(function(){var e=Object.assign({leaveDelay:300},_conf.default.form.tooltipConfig,k.tooltipConfig);return e.enterable&&(e.leaveMethod=n),e});var s,l={refElem:p},u={computeSize:v,computeValidOpts:g,computeTooltipOpts:h},z={xID:t,props:k,context:e,reactData:m,getRefMaps:function(){return l},getComputeMaps:function(){return u}},P=function(e,t){return e&&(_xeUtils.default.isString(e)&&(e=d[e]||null),_xeUtils.default.isFunction(e))?e(t):[]},o=function(e){return e.length&&("development"===process.env.NODE_ENV&&e.forEach(function(e){e.slots&&_xeUtils.default.each(e.slots,function(e){_xeUtils.default.isFunction(e)||d[e]||(0,_utils.errLog)("vxe.error.notSlot",[e])})}),m.staticItems=_xeUtils.default.mapTree(e,function(e){return(0,_util.createItem)(z,e)},{children:"children"})),(0,_vue.nextTick)()},c=function(){var t=[];return _xeUtils.default.eachTree(m.formItems,function(e){t.push(e)},{children:"children"}),t},x=function(){return m.collapseAll},b=function(){var e=!x();return m.collapseAll=e,r("update:collapseStatus",e),(0,_vue.nextTick)()},$=function(e){b();var t=x();i.dispatchEvent("toggle-collapse",{status:t,collapse:t,data:k.data},e),i.dispatchEvent("collapse",{status:t,collapse:t,data:k.data},e)},y=function(t){var e=c();if(t){var i=e.find(function(e){return e.field===t});i&&(i.showError=!1)}else e.forEach(function(e){e.showError=!1});return(0,_vue.nextTick)()},E=function(){var l=k.data,e=c();return l&&e.forEach(function(e){var t=e.field,i=e.resetValue,r=e.itemRender;if((0,_utils.isEnableConf)(r)){var n=_vXETable.VXETable.renderer.get(r.name);n&&n.itemResetMethod?n.itemResetMethod({data:l,property:t,item:e,$form:z}):t&&_xeUtils.default.set(l,t,null===i?getResetValue(_xeUtils.default.get(l,t),void 0):i)}}),y()},T=function(e){e.preventDefault(),E(),i.dispatchEvent("reset",{data:k.data},e)},U=function(u,o,e){var a=k.data,t=k.rules,s=[],c=[];if(o&&t){var f=_xeUtils.default.get(t,o);if(f){var d=_xeUtils.default.isUndefined(e)?_xeUtils.default.get(a,o):e;f.forEach(function(t){var e=t.type,i=t.trigger,r=t.required;if("all"===u||!i||u===i)if(_xeUtils.default.isFunction(t.validator)){var n=t.validator({itemValue:d,rule:t,rules:f,data:a,property:o,$form:z});n&&(_xeUtils.default.isError(n)?s.push(new Rule({type:"custom",trigger:i,message:n.message,rule:new Rule(t)})):n.catch&&c.push(n.catch(function(e){s.push(new Rule({type:"custom",trigger:i,message:e?e.message:t.message,rule:new Rule(t)}))})))}else{var l="array"===e?!_xeUtils.default.isArray(d)||!d.length:(0,_utils.eqEmptyValue)(d);(r?l||validErrorRuleValue(t,d):!l&&validErrorRuleValue(t,d))&&s.push(new Rule(t))}})}}return Promise.all(c).then(function(){if(s.length){var e={rules:s,rule:s[0]};return Promise.reject(e)}})},R=function(i,e,r){var l=k.data,t=k.rules,n=g.value,u={},a=[],o=[];return y(),clearTimeout(s),l&&t?(i.forEach(function(r){var n=r.field;n&&o.push(U(e||"all",n).then(function(){r.errRule=null}).catch(function(e){var t=e.rule,i={rule:t,rules:e.rules,data:l,property:n,$form:z};return u[n]||(u[n]=[]),u[n].push(i),a.push(n),r.errRule=t,Promise.reject(i)}))}),Promise.all(o).then(function(){r&&r()}).catch(function(){return new Promise(function(e,t){s=window.setTimeout(function(){i.forEach(function(e){e.errRule&&(e.showError=!0)})},20),!1!==n.autoPos&&(0,_vue.nextTick)(function(){var e,u,o;e=a,u=c(),o=p.value,e.some(function(t,e){var i=u.find(function(e){return e.field===t});if(i&&(0,_utils.isEnableConf)(i.itemRender)){var r=i.itemRender,n=_vXETable.VXETable.renderer.get(r.name),l=null;if(e||(0,_dom.scrollToView)(o.querySelector("."+i.id)),r.autofocus&&(l=o.querySelector("."+i.id+" "+r.autofocus)),!l&&n&&n.autofocus&&(l=o.querySelector("."+i.id+" "+n.autofocus)),l)return l.focus(),!0}})}),r?(r(u),e()):t(u)})})):(r&&r(),Promise.resolve())},S=function(t){t.preventDefault(),k.preventSubmit||R(c()).then(function(){i.dispatchEvent("submit",{data:k.data},t)}).catch(function(e){i.dispatchEvent("submit-invalid",{data:k.data,errMap:e},t)})},w=function(){var e=a.tooltipStore,t=_.value;return e.visible&&(Object.assign(e,{item:null,visible:!1}),t&&t.close()),(0,_vue.nextTick)()},L=function(e,t){var i=t.item,r=a.tooltipStore,n=_.value,l=e.currentTarget.children[0],u=(l.textContent||"").trim(),o=l.scrollWidth>l.clientWidth;clearTimeout(a.tooltipTimeout),a.tooltipActive=!0,w(),u&&o&&(Object.assign(r,{item:i,visible:!0}),n&&n.open(l,u))},W=function(){var e=h.value;a.tooltipActive=!1,e.enterable?a.tooltipTimeout=setTimeout(function(){var e=_.value;e&&!e.reactData.isHover&&w()},e.leaveDelay):w()};i={dispatchEvent:function(e,t,i){r(e,Object.assign({$form:z,$event:i},t))},reset:E,validate:function(e){return R(c(),"",e)},validateField:function(t,e){return R(c().filter(function(e){return e.field===t}),"",e)},clearValidate:y,updateStatus:function(e,t){var r=e.property;r&&U("change",r,t).then(function(){y(r)}).catch(function(e){var t=e.rule,i=c().find(function(e){return e.field===r});i&&(i.showError=!0,i.errRule=t)})},toggleCollapse:b,getItems:c,closeTooltip:w};var N={callSlot:P,toggleCollapseEvent:$,triggerHeaderHelpEvent:L,handleTargetLeaveEvent:W};Object.assign(z,i,N),(0,_vue.watch)(function(){return m.staticItems},function(e){m.formItems=e}),(0,_vue.watch)(function(){return k.items},function(e){o(e||[])}),(0,_vue.watch)(function(){return k.collapseStatus},function(e){m.collapseAll=!!e}),(0,_vue.onMounted)(function(){(0,_vue.nextTick)(function(){"development"===process.env.NODE_ENV&&k.customLayout&&k.items&&(0,_utils.errLog)("vxe.error.errConflicts",["custom-layout","items"]),o(k.items||[])})});return z.renderVN=function(){var e,t=k.loading,i=k.className,r=k.data,n=k.titleColon,l=k.titleAsterisk,u=k.customLayout,o=m.formItems,a=v.value,s=h.value,c=d.default;return(0,_vue.h)("form",{ref:p,class:["vxe-form",i?_xeUtils.default.isFunction(i)?i({items:o,data:r,$form:z}):i:"",(e={},e["size--"+a]=a,e["is--colon"]=n,e["is--asterisk"]=l,e["is--loading"]=t,e)],onSubmit:S,onReset:T},[(0,_vue.h)("div",{class:"vxe-form--wrapper vxe-row"},u?c?c({}):[]:function A(e){var j=k.data,M=k.rules,I=k.titleOverflow,D=m.collapseAll,F=g.value;return e.map(function(e,t){var i=e.slots,r=e.title,n=e.visible,l=e.folding,u=e.visibleMethod,o=e.field,a=e.collapseNode,s=e.itemRender,c=e.showError,f=e.errRule,d=e.className,v=e.titleOverflow,m=e.children,p=(0,_utils.isEnableConf)(s)?_vXETable.VXETable.renderer.get(s.name):null,_=i?i.default:null,g=i?i.title:null,h=e.span||k.span,x=e.align||k.align,b=e.titleAlign||k.titleAlign,y=e.titleWidth||k.titleWidth,E=_xeUtils.default.isUndefined(v)||_xeUtils.default.isNull(v)?I:v,T="title"===E,U=!0===E||"tooltip"===E,R=T||U||"ellipsis"===E,S=u,w={data:j,property:o,item:e,$form:z};if(!1===n)return(0,_vue.createCommentVNode)();var N=!1;if(M){var O=M[o];O&&(N=O.some(function(e){return e.required}))}if(m&&0<m.length){var C=A(e.children);return C.length?(0,_vue.h)("div",{class:["vxe-form--gather vxe-row",e.id,h?"vxe-col--"+h+" is--span":"",d?_xeUtils.default.isFunction(d)?d(w):d:""]},C):(0,_vue.createCommentVNode)()}!S&&p&&p.itemVisibleMethod&&(S=p.itemVisibleMethod);var V=[];_?V=P(_,w):p&&p.renderItemContent?V=p.renderItemContent(s,w):o&&(V=[""+_xeUtils.default.get(j,o)]),a&&V.push((0,_vue.h)("div",{class:"vxe-form--item-trigger-node",onClick:$},[(0,_vue.h)("span",{class:"vxe-form--item-trigger-text"},D?_conf.default.i18n("vxe.form.unfolding"):_conf.default.i18n("vxe.form.folding")),(0,_vue.h)("i",{class:["vxe-form--item-trigger-icon",D?_conf.default.icon.FORM_FOLDING:_conf.default.icon.FORM_UNFOLDING]})])),f&&F.showMessage&&V.push((0,_vue.h)("div",{class:"vxe-form--item-valid",style:f.maxWidth?{width:f.maxWidth+"px"}:null},f.message));var q=U?{onMouseenter:function(e){L(e,w)},onMouseleave:W}:{};return(0,_vue.h)("div",{class:["vxe-form--item",e.id,h?"vxe-col--"+h+" is--span":"",d?_xeUtils.default.isFunction(d)?d(w):d:"",{"is--title":r,"is--required":N,"is--hidden":l&&D,"is--active":!S||S(w),"is--error":c}],key:t},[(0,_vue.h)("div",{class:"vxe-form--item-inner"},[r||g?(0,_vue.h)("div",__assign({class:["vxe-form--item-title",b?"align--"+b:null,{"is--ellipsis":R}],style:y?{width:isNaN(y)?y:y+"px"}:null,title:T?(0,_utils.getFuncText)(r):null},q),(0,_render.renderTitle)(z,e)):null,(0,_vue.h)("div",{class:["vxe-form--item-content",x?"align--"+x:null]},V)])])})}(o)),(0,_vue.h)("div",{class:"vxe-form-slots",ref:"hideItem"},u?[]:c?c({}):[]),(0,_vue.h)("div",{class:["vxe-loading",{"is--visible":t}]},[(0,_vue.h)("div",{class:"vxe-loading--spinner"})]),f?(0,_vue.h)((0,_vue.resolveComponent)("vxe-tooltip"),__assign({ref:_},s)):(0,_vue.createCommentVNode)()])},(0,_vue.provide)("$xeform",z),z},render:function(){return this.renderVN()}});exports.default=_default2;