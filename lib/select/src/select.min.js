"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_size=require("../../hooks/size"),_dom=require("../../tools/dom"),_utils=require("../../tools/utils"),_event=require("../../tools/event");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function isOptionVisible(e){return!1!==e.visible}function getOptUniqueId(){return _xeUtils.default.uniqueId("opt_")}var _default2=(0,_vue.defineComponent)({name:"VxeSelect",props:{modelValue:null,clearable:Boolean,placeholder:String,loading:Boolean,disabled:Boolean,multiple:Boolean,multiCharOverflow:{type:[Number,String],default:function(){return _conf.default.select.multiCharOverflow}},prefixIcon:String,placement:String,options:Array,optionProps:Object,optionGroups:Array,optionGroupProps:Object,className:[String,Function],size:{type:String,default:function(){return _conf.default.select.size||_conf.default.size}},emptyText:String,optionId:{type:String,default:function(){return _conf.default.select.optionId}},optionKey:Boolean,transfer:{type:Boolean,default:function(){return _conf.default.select.transfer}}},emits:["update:modelValue","change","clear"],setup:function(x,e){var n,c=e.slots,i=e.emit,t=_xeUtils.default.uniqueId(),p=(0,_size.useSize)(x),h=(0,_vue.reactive)({inited:!1,staticOptions:[],fullGroupList:[],fullOptionList:[],visibleGroupList:[],visibleOptionList:[],panelIndex:0,panelStyle:{},panelPlacement:null,currentValue:null,visiblePanel:!1,animatVisible:!1,isActivated:!1}),g=(0,_vue.ref)(),d=(0,_vue.ref)(),_=(0,_vue.ref)(),E=(0,_vue.ref)(),o={refElem:g},m={xID:t,props:x,context:e,reactData:h,getRefMaps:function(){return o}},l={},u=(0,_vue.computed)(function(){return x.optionProps||{}}),r=(0,_vue.computed)(function(){return x.optionGroupProps||{}}),a=(0,_vue.computed)(function(){return u.value.label||"label"}),O=(0,_vue.computed)(function(){return u.value.value||"value"}),f=(0,_vue.computed)(function(){return r.value.label||"label"}),T=(0,_vue.computed)(function(){return r.value.options||"options"}),L=(0,_vue.computed)(function(){return h.fullGroupList.some(function(e){return e.options&&e.options.length})}),s=(0,_vue.computed)(function(){return _xeUtils.default.toNumber(x.multiCharOverflow)}),y=function(e,t){return e&&(_xeUtils.default.isString(e)&&(e=c[e]||null),_xeUtils.default.isFunction(e))?e(t):[]},b=function(t){var e=h.fullOptionList,n=h.fullGroupList,i=L.value,o=O.value;if(i)for(var l=0;l<n.length;l++){var u=n[l];if(u.options)for(var r=0;r<u.options.length;r++){var a=u.options[r];if(t===a[o])return a}}return e.find(function(e){return t===e[o]})},v=function(e){var t=a.value,n=b(e);return _xeUtils.default.toValueString(n?n[t]:e)},V=(0,_vue.computed)(function(){var e=x.modelValue,t=x.multiple,n=s.value;return e&&t?(_xeUtils.default.isArray(e)?e:[e]).map(function(e){var t=v(e);return 0<n&&t.length>n?t.substring(0,n)+"...":t}).join(", "):v(e)}),P=function(){return x.optionId||"_XID"},S=function(e){var t=e[P()];return t?encodeURIComponent(t):""},G=function(){var e=h.fullOptionList,t=h.fullGroupList;return L.value?h.visibleGroupList=t.filter(isOptionVisible):h.visibleOptionList=e.filter(isOptionVisible),(0,_vue.nextTick)()},A=function(){var e=h.fullOptionList,t=h.fullGroupList,n=T.value,i=P(),o=function(e){S(e)||(e[i]=getOptUniqueId())};t.length?t.forEach(function(e){o(e),e[n]&&e[n].forEach(o)}):e.length&&e.forEach(o),G()},I=function(e){var t=O.value;e&&(h.currentValue=e[t])},N=function(i,o){return(0,_vue.nextTick)().then(function(){if(i){var e=_.value,t=E.value.querySelector("[optid='"+S(i)+"']");if(e&&t){var n=e.offsetHeight;o?t.offsetTop+t.offsetHeight-e.scrollTop>n&&(e.scrollTop=t.offsetTop+t.offsetHeight-n):(t.offsetTop+5<e.scrollTop||t.offsetTop+5>e.scrollTop+e.clientHeight)&&(e.scrollTop=t.offsetTop-5)}}})},k=function(){return(0,_vue.nextTick)().then(function(){var e=x.transfer,t=x.placement,n=h.panelIndex,i=g.value,o=E.value;if(o&&i){var l=i.offsetHeight,u=i.offsetWidth,r=o.offsetHeight,a=o.offsetWidth,s={zIndex:n},f=(0,_dom.getAbsolutePos)(i),v=f.boundingTop,c=f.boundingLeft,p=f.visibleHeight,d=f.visibleWidth,_="bottom";if(e){var b=c,m=v+l;"top"===t?(_="top",m=v-r):t||(p<m+r+5&&(_="top",m=v-r),m<5&&(_="bottom",m=v+l)),d<b+a+5&&(b-=b+a+5-d),b<5&&(b=5),Object.assign(s,{left:b+"px",top:m+"px",minWidth:u+"px"})}else"top"===t?(_="top",s.bottom=l+"px"):t||p<v+l+r&&5<v-l-r&&(_="top",s.bottom=l+"px");return h.panelStyle=s,h.panelPlacement=_,(0,_vue.nextTick)()}})},w=function(){var e=x.loading,t=x.disabled;e||t||(clearTimeout(n),h.inited||(h.inited=!0),h.isActivated=!0,h.animatVisible=!0,setTimeout(function(){var e=x.modelValue,t=x.multiple,n=b(t&&e?e[0]:e);h.visiblePanel=!0,n&&(I(n),N(n))},10),h.panelIndex<(0,_utils.getLastZIndex)()&&(h.panelIndex=(0,_utils.nextZIndex)()),k())},K=function(){h.visiblePanel=!1,n=window.setTimeout(function(){h.animatVisible=!1},350)},C=function(e,t){t!==x.modelValue&&(i("update:modelValue",t),l.dispatchEvent("change",{value:t},e))},U=function(e,t){C(e,t),l.dispatchEvent("clear",{value:t},e)},q=function(e,t){U(t,null),K()},D=function(e,t){var n=x.modelValue;if(x.multiple){var i=void 0;i=n?-1===n.indexOf(t)?n.concat([t]):n.filter(function(e){return e!==t}):[t],C(e,i)}else C(e,t),K()},R=function(e){var t=x.disabled,n=h.visiblePanel;if(!t&&n){var i=E.value;(0,_dom.getEventTargetNode)(e,i).flag?k():K()}},z=function(e){var t=x.disabled,n=h.visiblePanel;if(!t){var i=g.value,o=E.value;h.isActivated=(0,_dom.getEventTargetNode)(e,i).flag||(0,_dom.getEventTargetNode)(e,o).flag,n&&!h.isActivated&&K()}},B=function(e){var t=x.clearable,n=x.disabled,i=h.visiblePanel,o=h.currentValue;if(!n){var l=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.TAB),u=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ENTER),r=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ESCAPE),a=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ARROW_UP),s=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ARROW_DOWN),f=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.DELETE),v=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.SPACEBAR);if(l&&(h.isActivated=!1),i)if(r||l)K();else if(u)e.preventDefault(),e.stopPropagation(),D(e,o);else if(a||s){e.preventDefault();var c=function(e,t){var n,i,o,l,u=h.visibleOptionList,r=h.visibleGroupList,a=L.value,s=O.value,f=T.value;if(a)for(var v=0;v<r.length;v++){var c=r[v],p=c[f],d=c.disabled;if(p)for(var _=0;_<p.length;_++){var b=isOptionVisible(x=p[_]),m=d||x.disabled;if(n||m||(n=x),l&&b&&!m&&(o=x,!t))return{offsetOption:o};if(e===x[s]){if(l=x,t)return{offsetOption:i}}else b&&!m&&(i=x)}}else for(_=0;_<u.length;_++){var x;if(m=(x=u[_]).disabled,n||m||(n=x),l&&!m&&(o=x,!t))return{offsetOption:o};if(e===x[s]){if(l=x,t)return{offsetOption:i}}else m||(i=x)}return{firstOption:n}}(o,a),p=c.firstOption,d=c.offsetOption;d||b(o)||(d=p),I(d),N(d,s)}else v&&e.preventDefault();else(a||s||u||v)&&h.isActivated&&(e.preventDefault(),w());h.isActivated&&f&&t&&U(e,null)}},$=function(){K()},F=function(){x.disabled||(h.isActivated=!0)},j=function(){h.isActivated=!1},H=function(e){e.$event.preventDefault(),h.visiblePanel?K():w()},W=function(e,s){var f=x.optionKey,v=x.modelValue,c=x.multiple,p=h.currentValue,d=a.value,_=O.value,b=L.value;return e.map(function(e,t){var n=e.slots,i=e.className,o=!b||isOptionVisible(e),l=s&&s.disabled||e.disabled,u=e[_],r=S(e),a=n?n.default:null;return o?(0,_vue.h)("div",{key:f?r:t,class:["vxe-select-option",i?_xeUtils.default.isFunction(i)?i({option:e,$select:m}):i:"",{"is--disabled":l,"is--selected":c?v&&-1<v.indexOf(u):v===u,"is--hover":p===u}],optid:r,onMousedown:function(e){0===e.button&&e.stopPropagation()},onClick:function(e){l||D(e,u)},onMouseenter:function(){l||I(e)}},a?y(a,{option:e,$select:m}):(0,_utils.formatText)((0,_utils.getFuncText)(e[d]))):null})},Y=function(){var r,e,a,s,t=h.visibleGroupList,n=h.visibleOptionList;if(L.value){if(t.length)return r=x.optionKey,e=h.visibleGroupList,a=f.value,s=T.value,e.map(function(e,t){var n=e.slots,i=e.className,o=S(e),l=e.disabled,u=n?n.default:null;return(0,_vue.h)("div",{key:r?o:t,class:["vxe-optgroup",i?_xeUtils.default.isFunction(i)?i({option:e,$select:m}):i:"",{"is--disabled":l}],optid:o},[(0,_vue.h)("div",{class:"vxe-optgroup--title"},u?y(u,{option:e,$select:m}):(0,_utils.getFuncText)(e[a])),(0,_vue.h)("div",{class:"vxe-optgroup--wrapper"},W(e[s]||[],e))])})}else if(n.length)return W(n);return[(0,_vue.h)("div",{class:"vxe-select--empty-placeholder"},x.emptyText||_conf.default.i18n("vxe.select.emptyText"))]};l={dispatchEvent:function(e,t,n){i(e,Object.assign({$select:m,$event:n},t))},isPanelVisible:function(){return h.visiblePanel},togglePanel:function(){return h.visiblePanel?K():w(),(0,_vue.nextTick)()},hidePanel:function(){return h.visiblePanel&&K(),(0,_vue.nextTick)()},showPanel:function(){return h.visiblePanel||w(),(0,_vue.nextTick)()},refreshOption:G,focus:function(){var e=d.value;return h.isActivated=!0,e.blur(),(0,_vue.nextTick)()},blur:function(){return d.value.blur(),h.isActivated=!1,(0,_vue.nextTick)()}},Object.assign(m,l),(0,_vue.watch)(function(){return h.staticOptions},function(e){e.some(function(e){return e.options&&e.options.length})?(h.fullOptionList=[],h.fullGroupList=e):(h.fullGroupList=[],h.fullOptionList=e||[]),A()}),(0,_vue.watch)(function(){return x.options},function(e){h.fullGroupList=[],h.fullOptionList=e||[],A()}),(0,_vue.watch)(function(){return x.optionGroups},function(e){h.fullOptionList=[],h.fullGroupList=e||[],A()}),(0,_vue.onMounted)(function(){(0,_vue.nextTick)(function(){var e=x.options,t=x.optionGroups;t?h.fullGroupList=t:e&&(h.fullOptionList=e),A()}),_event.GlobalEvent.on(m,"mousewheel",R),_event.GlobalEvent.on(m,"mousedown",z),_event.GlobalEvent.on(m,"keydown",B),_event.GlobalEvent.on(m,"blur",$)}),(0,_vue.onUnmounted)(function(){_event.GlobalEvent.off(m,"mousewheel"),_event.GlobalEvent.off(m,"mousedown"),_event.GlobalEvent.off(m,"keydown"),_event.GlobalEvent.off(m,"blur")});return m.renderVN=function(){var e,t,n=x.className,i=x.transfer,o=x.disabled,l=x.loading,u=h.inited,r=h.isActivated,a=h.visiblePanel,s=p.value,f=V.value,v=c.prefix;return(0,_vue.h)("div",{ref:g,class:["vxe-select",n?_xeUtils.default.isFunction(n)?n({$select:m}):n:"",(e={},e["size--"+s]=s,e["is--visivle"]=a,e["is--disabled"]=o,e["is--loading"]=l,e["is--active"]=r,e)]},[(0,_vue.h)("div",{class:"vxe-select-slots",ref:"hideOption"},c.default?c.default({}):[]),(0,_vue.h)((0,_vue.resolveComponent)("vxe-input"),{ref:d,clearable:x.clearable,placeholder:x.placeholder,readonly:!0,disabled:o,type:"text",prefixIcon:x.prefixIcon,suffixIcon:l?_conf.default.icon.SELECT_LOADED:a?_conf.default.icon.SELECT_OPEN:_conf.default.icon.SELECT_CLOSE,modelValue:f,onClear:q,onClick:H,onFocus:F,onBlur:j,onSuffixClick:H},v?{prefix:function(){return v({})}}:{}),(0,_vue.h)(_vue.Teleport,{to:"body",disabled:!i||!u},[(0,_vue.h)("div",{ref:E,class:["vxe-table--ignore-clear vxe-select--panel",(t={},t["size--"+s]=s,t["is--transfer"]=i,t["animat--leave"]=!l&&h.animatVisible,t["animat--enter"]=!l&&a,t)],placement:h.panelPlacement,style:h.panelStyle},u?[(0,_vue.h)("div",{ref:_,class:"vxe-select-option--wrapper"},Y())]:[])])])},(0,_vue.provide)("$xeselect",m),m},render:function(){return this.renderVN()}});exports.default=_default2;