"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_vXETable=require("../../v-x-e-table"),_dom=require("../../tools/dom"),_utils=require("../../tools/utils"),_event=require("../../tools/event");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,n=1,l=arguments.length;n<l;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},tableMenuMethodKeys=["closeMenu"],tableMenuHook={setupTable:function(w){var N=w.xID,O=w.props,R=w.reactData,k=w.internalData,e=w.getRefMaps(),D=e.refElem,S=e.refTableFilter,A=e.refTableMenu,t=w.getComputeMaps(),K=t.computeMouseOpts,r=t.computeIsMenu,P=t.computeMenuOpts,W={},d={},q=function(n,e,l){var f=R.ctxMenuStore,t=r.value,o=P.value,i=o[e],g=o.visibleMethod;if(i){var h=i.options;i.disabled?n.preventDefault():t&&h&&h.length&&(l.options=h,w.preventEvent(n,"event.showMenu",l,function(){if(!g||g(l)){n.preventDefault(),w.updateZindex();var e=(0,_dom.getDomNode)(),r=e.scrollTop,u=e.scrollLeft,s=e.visibleHeight,a=e.visibleWidth,d=n.clientY+r,v=n.clientX+u,o=function(){k._currMenuParams=l,Object.assign(f,{visible:!0,list:h,selected:null,selectChild:null,showChild:!1,style:{zIndex:k.tZindex,top:d+"px",left:v+"px"}}),(0,_vue.nextTick)(function(){var e=A.value.getRefMaps().refElem.value,t=e.clientHeight,n=e.clientWidth,l=(0,_dom.getAbsolutePos)(e),o=l.boundingTop,i=l.boundingLeft+n-a;-10<o+t-s&&(f.style.top=Math.max(r+2,d-t-2)+"px"),-10<i&&(f.style.left=Math.max(u+2,v-n-2)+"px")})},t=l.keyboard,i=l.row,c=l.column;t&&i&&c?w.scrollToRow(i,c).then(function(){var e=w.getCell(i,c);if(e){var t=(0,_dom.getAbsolutePos)(e),n=t.boundingTop,l=t.boundingLeft;d=n+r+Math.floor(e.offsetHeight/2),v=l+u+Math.floor(e.offsetWidth/2)}o()}):o()}else W.closeMenu()}))}w.closeFilter()};return d={moveCtxMenu:function(e,t,n,l,o,i){var r,u=_xeUtils.default.findIndexOf(i,function(e){return t[n]===e});if(l)o&&(0,_utils.hasChildrenList)(t.selected)?t.showChild=!0:(t.showChild=!1,t.selectChild=null);else if((0,_event.hasEventKey)(e,_event.EVENT_KEYS.ARROW_UP)){for(var s=u-1;0<=s;s--)if(!1!==i[s].visible){r=i[s];break}t[n]=r||i[i.length-1]}else if((0,_event.hasEventKey)(e,_event.EVENT_KEYS.ARROW_DOWN)){for(var a=u+1;a<i.length;a++)if(!1!==i[a].visible){r=i[a];break}t[n]=r||i[0]}else t[n]&&((0,_event.hasEventKey)(e,_event.EVENT_KEYS.ENTER)||(0,_event.hasEventKey)(e,_event.EVENT_KEYS.SPACEBAR))&&d.ctxMenuLinkEvent(e,t[n])},handleGlobalContextmenuEvent:function(e){var t=O.mouseConfig,n=O.menuConfig,l=R.editStore,o=R.ctxMenuStore,i=k.visibleColumn,r=S.value,u=A.value,s=K.value,a=P.value,d=D.value,v=l.selected,c=["header","body","footer"];if((0,_utils.isEnableConf)(n)){if(o.visible&&u&&(0,_dom.getEventTargetNode)(e,u.getRefMaps().refElem.value).flag)return void e.preventDefault();if(k._keyCtx){var f="body",g={type:f,$table:w,keyboard:!0,columns:i.slice(0),$event:e};if(t&&s.area){var h=w.getActiveCellArea();if(h&&h.row&&h.column)return g.row=h.row,g.column=h.column,void q(e,f,g)}else if(t&&s.selected&&v.row&&v.column)return g.row=v.row,g.column=v.column,void q(e,f,g)}for(var b=0;b<c.length;b++){var p=c[b],_=(0,_dom.getEventTargetNode)(e,d,"vxe-"+p+"--column",function(e){return e.parentNode.parentNode.parentNode.getAttribute("xid")===N});g={type:p,$table:w,columns:i.slice(0),$event:e};if(_.flag){var m=_.targetElem,x=w.getColumnNode(m),M=x?x.item:null,E=p+"-";if(M&&Object.assign(g,{column:M,columnIndex:w.getColumnIndex(M),cell:m}),"body"===p){var C=w.getRowNode(m.parentNode),y=C?C.item:null;E="",y&&(g.row=y,g.rowIndex=w.getRowIndex(y))}var T=E+"cell-menu";return q(e,p,g),void w.dispatchEvent(T,g,e)}if((0,_dom.getEventTargetNode)(e,d,"vxe-table--"+p+"-wrapper",function(e){return e.getAttribute("xid")===N}).flag)return void("cell"===a.trigger?e.preventDefault():q(e,p,g))}}r&&!(0,_dom.getEventTargetNode)(e,r.$el).flag&&w.closeFilter(),W.closeMenu()},ctxMenuMouseoverEvent:function(e,t,n){var v=e.currentTarget,l=R.ctxMenuStore;e.preventDefault(),e.stopPropagation(),l.selected=t,(l.selectChild=n)||(l.showChild=(0,_utils.hasChildrenList)(t),l.showChild&&(0,_vue.nextTick)(function(){var e=v.nextElementSibling;if(e){var t=(0,_dom.getAbsolutePos)(v),n=t.boundingTop,l=t.boundingLeft,o=t.visibleHeight,i=t.visibleWidth,r=n+v.offsetHeight,u="",s="";l+v.offsetWidth+e.offsetWidth>i-10&&(u="auto",s=v.offsetWidth+"px");var a="",d="";r+e.offsetHeight>o-10&&(a="auto",d="0"),e.style.left=u,e.style.right=s,e.style.top=a,e.style.bottom=d}}))},ctxMenuMouseoutEvent:function(e,t){var n=R.ctxMenuStore;t.children||(n.selected=null),n.selectChild=null},ctxMenuLinkEvent:function(e,t){if(!t.disabled&&(t.code||!t.children||!t.children.length)){var n=_vXETable.VXETable.menus.get(t.code),l=Object.assign({},k._currMenuParams,{menu:t,$table:w,$grid:w.xegrid,$event:e});n&&n(l,e),w.dispatchEvent("menu-click",l,e),W.closeMenu()}}},__assign(__assign({},W={closeMenu:function(){return Object.assign(R.ctxMenuStore,{visible:!1,selected:null,selectChild:null,showChild:!1}),(0,_vue.nextTick)()}}),d)},setupGrid:function(e){return e.extendTableMethods(tableMenuMethodKeys)}},_default=tableMenuHook;exports.default=_default;