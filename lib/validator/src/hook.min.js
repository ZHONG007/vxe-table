"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_utils=require("../../tools/utils"),_dom=require("../../tools/dom");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,r=1,l=arguments.length;r<l;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},Rule=function(){function e(e){Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.max,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}return Object.defineProperty(e.prototype,"message",{get:function(){return(0,_utils.getFuncText)(this.$options.message)},enumerable:!1,configurable:!0}),e}(),tableValidatorMethodKeys=["fullValidate","validate","clearValidate"],validatorHook={setupTable:function(v){var g,p=v.props,d=v.reactData,m=v.internalData,f=v.getRefMaps().refValidTooltip,e=v.getComputeMaps(),h=e.computeValidOpts,_=e.computeTreeOpts,x=e.computeEditOpts,w={},R={},r=function(e,o,i){var t,s={},n=p.editRules,c=p.treeConfig,d=m.afterFullData,r=_.value,f=h.value;!0===e?t=d:e&&(_xeUtils.default.isFunction(e)?o=e:t=_xeUtils.default.isArray(e)?e:[e]),t||(t=v.getInsertRecords?v.getInsertRecords().concat(v.getUpdateRecords()):[]);var a=[];if(m._lastCallTime=Date.now(),g=!1,w.clearValidate(),n){var u=v.getColumns(),l=function(l){if(i||!g){var e=[];u.forEach(function(r){!i&&g||!_xeUtils.default.has(n,r.property)||e.push(R.validCellRules("all",l,r).catch(function(e){var t={rule:e.rule,rules:e.rules,rowIndex:v.getRowIndex(l),row:l,columnIndex:v.getColumnIndex(r),column:r,$table:v};if(s[r.property]||(s[r.property]=[]),s[r.property].push(t),!i)return g=!0,Promise.reject(t)}))}),a.push(Promise.all(e))}};return c?_xeUtils.default.eachTree(t,l,r):t.forEach(l),Promise.all(a).then(function(){var e=Object.keys(s);return(0,_vue.nextTick)().then(function(){if(e.length)return Promise.reject(s[e[0]][0]);o&&o()})}).catch(function(u){return new Promise(function(e,t){var r=function(){(0,_vue.nextTick)(function(){o?(o(s),e()):t(s)})},l=function(){var t;u.cell=v.getCell(u.row,u.column),(0,_dom.scrollToView)(u.cell),(t=u,new Promise(function(e){!1===h.value.autoPos?(v.dispatchEvent("valid-error",t,null),e()):v.handleActived(t,{type:"valid-error",trigger:"call"}).then(function(){setTimeout(function(){e(R.showValidTooltip(t))},10)})})).then(r)},i=u.row,n=d.indexOf(i),a=0<n?d[n-1]:i;!1===f.autoPos?r():c?v.scrollToTreeRow(a).then(l):v.scrollToRow(a).then(l)})})}return(0,_vue.nextTick)().then(function(){o&&o()})},y=function(e,t){var r=e.type,l=e.min,i=e.max,n=e.pattern,a="number"===r,u=a?_xeUtils.default.toNumber(t):_xeUtils.default.getSize(t);return!(!a||!isNaN(t))||(!_xeUtils.default.eqNull(l)&&u<_xeUtils.default.toNumber(l)||(!_xeUtils.default.eqNull(i)&&u>_xeUtils.default.toNumber(i)||!(!n||(_xeUtils.default.isRegExp(n)?n:new RegExp(n)).test(t))))};return R={validCellRules:function(a,u,o,e){var t=p.editRules,r=o.property,s=[],c=[];if(r&&t){var d=_xeUtils.default.get(t,r);if(d){var f=_xeUtils.default.isUndefined(e)?_xeUtils.default.get(u,r):e;d.forEach(function(t){var e=t.type,r=t.trigger,l=t.required;if("all"===a||!r||a===r)if(_xeUtils.default.isFunction(t.validator)){var i=t.validator({cellValue:f,rule:t,rules:d,row:u,rowIndex:v.getRowIndex(u),column:o,columnIndex:v.getColumnIndex(o),$table:v});i&&(_xeUtils.default.isError(i)?(g=!0,s.push(new Rule({type:"custom",trigger:r,message:i.message,rule:new Rule(t)}))):i.catch&&c.push(i.catch(function(e){g=!0,s.push(new Rule({type:"custom",trigger:r,message:e&&e.message?e.message:t.message,rule:new Rule(t)}))})))}else{var n="array"===e?!_xeUtils.default.isArray(f)||!f.length:(0,_utils.eqEmptyValue)(f);(l?n||y(t,f):!n&&y(t,f))&&(g=!0,s.push(new Rule(t)))}})}}return Promise.all(c).then(function(){if(s.length){var e={rules:s,rule:s[0]};return Promise.reject(e)}})},hasCellRules:function(t,e,r){var l=p.editRules,i=r.property;if(i&&l){var n=_xeUtils.default.get(l,i);return n&&!!_xeUtils.default.find(n,function(e){return"all"===t||!e.trigger||t===e.trigger})}return!1},triggerValidate:function(l){var e=p.editConfig,t=p.editRules,r=d.editStore,i=d.validStore,n=r.actived,a=x.value;if(e&&t&&n.row){var u=n.args,o=u.row,s=u.column,c=u.cell;if(R.hasCellRules(l,o,s))return R.validCellRules(l,o,s).then(function(){"row"===a.mode&&i.visible&&i.row===o&&i.column===s&&w.clearValidate()}).catch(function(e){var t=e.rule;if(t.trigger&&l!==t.trigger)return Promise.resolve();var r={rule:t,row:o,column:s,cell:c};return R.showValidTooltip(r),Promise.reject(r)})}return Promise.resolve()},showValidTooltip:function(e){var t=p.height,r=d.tableData,l=d.validStore,i=h.value,n=e.rule,a=e.row,u=e.column,o=e.cell,s=f.value,c=n.message;return(0,_vue.nextTick)().then(function(){if(Object.assign(l,{row:a,column:u,rule:n,content:c,visible:!0}),v.dispatchEvent("valid-error",e,null),s&&("tooltip"===i.message||"default"===i.message&&!t&&r.length<2))return s.open(o,c)})}},__assign(__assign({},w={fullValidate:function(e,t){return r(e,t,!0)},validate:function(e,t){return r(e,t)},clearValidate:function(){var e=d.validStore,t=f.value;return Object.assign(e,{visible:!1,row:null,column:null,content:"",rule:null}),t&&t.reactData.visible&&t.close(),(0,_vue.nextTick)()}}),R)},setupGrid:function(e){return e.extendTableMethods(tableValidatorMethodKeys)}},_default=validatorHook;exports.default=_default;