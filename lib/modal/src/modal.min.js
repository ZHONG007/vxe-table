"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.msgQueue=exports.default=exports.allActivedModals=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_size=require("../../hooks/size"),_dom=require("../../tools/dom"),_utils=require("../../tools/utils"),_event=require("../../tools/event"),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_button=_interopRequireDefault(require("../../button/src/button"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,o=1,n=arguments.length;o<n;o++)for(var i in t=arguments[o])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},allActivedModals=[];exports.allActivedModals=allActivedModals;var msgQueue=[];exports.msgQueue=msgQueue;var _default2=(0,_vue.defineComponent)({name:"VxeModal",props:{modelValue:Boolean,id:String,type:{type:String,default:"modal"},loading:{type:Boolean,default:null},status:String,iconStatus:String,className:String,top:{type:[Number,String],default:function(){return _conf.default.modal.top}},position:[String,Object],title:String,duration:{type:[Number,String],default:function(){return _conf.default.modal.duration}},message:[Number,String],content:[Number,String],cancelButtonText:{type:String,default:function(){return _conf.default.modal.cancelButtonText}},confirmButtonText:{type:String,default:function(){return _conf.default.modal.confirmButtonText}},lockView:{type:Boolean,default:function(){return _conf.default.modal.lockView}},lockScroll:Boolean,mask:{type:Boolean,default:function(){return _conf.default.modal.mask}},maskClosable:{type:Boolean,default:function(){return _conf.default.modal.maskClosable}},escClosable:{type:Boolean,default:function(){return _conf.default.modal.escClosable}},resize:Boolean,showHeader:{type:Boolean,default:function(){return _conf.default.modal.showHeader}},showFooter:{type:Boolean,default:function(){return _conf.default.modal.showFooter}},showZoom:Boolean,showClose:{type:Boolean,default:function(){return _conf.default.modal.showClose}},dblclickZoom:{type:Boolean,default:function(){return _conf.default.modal.dblclickZoom}},width:[Number,String],height:[Number,String],minWidth:{type:[Number,String],default:function(){return _conf.default.modal.minWidth}},minHeight:{type:[Number,String],default:function(){return _conf.default.modal.minHeight}},zIndex:Number,marginSize:{type:[Number,String],default:function(){return _conf.default.modal.marginSize}},fullscreen:Boolean,draggable:{type:Boolean,default:function(){return _conf.default.modal.draggable}},remember:{type:Boolean,default:function(){return _conf.default.modal.remember}},destroyOnClose:{type:Boolean,default:function(){return _conf.default.modal.destroyOnClose}},showTitleOverflow:{type:Boolean,default:function(){return _conf.default.modal.showTitleOverflow}},transfer:{type:Boolean,default:function(){return _conf.default.modal.transfer}},storage:{type:Boolean,default:function(){return _conf.default.modal.storage}},storageKey:{type:String,default:function(){return _conf.default.modal.storageKey}},animat:{type:Boolean,default:function(){return _conf.default.modal.animat}},size:{type:String,default:function(){return _conf.default.modal.size||_conf.default.size}},beforeHideMethod:{type:Function,default:function(){return _conf.default.modal.beforeHideMethod}},slots:Object},emits:["update:modelValue","show","hide","before-hide","close","confirm","cancel","zoom"],setup:function(k,e){var N=e.slots,a=e.emit,t=_xeUtils.default.uniqueId(),S=(0,_size.useSize)(k),T=(0,_vue.reactive)({inited:!1,visible:!1,contentVisible:!1,modalTop:0,modalZindex:0,zoomLocat:null,firstOpen:!1}),O=(0,_vue.ref)(),B=(0,_vue.ref)(),s=(0,_vue.ref)(),r=(0,_vue.ref)(),o={refElem:O},M={xID:t,props:k,context:e,reactData:T,getRefMaps:function(){return o}},z={},L=(0,_vue.computed)(function(){return"message"===k.type}),C=function(){return B.value},l=function(){var e=k.width,t=k.height,o=C();return o.style.width=""+(e?isNaN(e)?e:e+"px":""),o.style.height=""+(t?isNaN(t)?t:t+"px":""),(0,_vue.nextTick)()},c=function(){var e=k.zIndex,t=T.modalZindex;e?T.modalZindex=e:t<(0,_utils.getLastZIndex)()&&(T.modalZindex=(0,_utils.nextZIndex)())},d=function(){return(0,_vue.nextTick)().then(function(){var e=k.position,t=_xeUtils.default.toNumber(k.marginSize),o=C(),n=document.documentElement.clientWidth||document.body.clientWidth,i=document.documentElement.clientHeight||document.body.clientHeight,l="center"===e,u=_xeUtils.default.isString(e)?{top:e,left:e}:Object.assign({},e),a=u.top,s=u.left,r=l||"center"===a,c="",d="";d=s&&!(l||"center"===s)?isNaN(s)?s:s+"px":Math.max(t,n/2-o.offsetWidth/2)+"px",c=a&&!r?isNaN(a)?a:a+"px":Math.max(t,i/2-o.offsetHeight/2)+"px",o.style.top=c,o.style.left=d})},f=function(){(0,_vue.nextTick)(function(){var o=0;msgQueue.forEach(function(e){var t=e.getBox();o+=_xeUtils.default.toNumber(e.props.top),e.reactData.modalTop=o,o+=t.clientHeight})})},u=function(){-1<msgQueue.indexOf(M)&&_xeUtils.default.remove(msgQueue,function(e){return e===M}),f()},m=function(e){var t=k.remember,o=k.beforeHideMethod,n=T.visible,i=L.value,l={type:e};return n&&Promise.resolve(o?o(l):null).then(function(e){_xeUtils.default.isError(e)||(i&&u(),T.contentVisible=!1,t||(T.zoomLocat=null),_xeUtils.default.remove(allActivedModals,function(e){return e===M}),z.dispatchEvent("before-hide",l),setTimeout(function(){T.visible=!1,a("update:modelValue",!1),z.dispatchEvent("hide",l)},200))}).catch(function(e){return e}),(0,_vue.nextTick)()},h=function(e){var t="close";z.dispatchEvent(t,{type:t},e),m(t)},v=function(e){var t="confirm";z.dispatchEvent(t,{type:t},e),m(t)},p=function(e){var t="cancel";z.dispatchEvent(t,{type:t},e),m(t)},_=function(e){var t=_conf.default.version,o=_xeUtils.default.toStringJSON(localStorage.getItem(e)||"");return o&&o._v===t?o:{_v:t}},E=function(){var e=k.id,t=k.remember,o=k.storage,n=k.storageKey,i=T.zoomLocat;if(e&&t&&o){var l=C(),u=_(n);u[e]=[l.style.left,l.style.top,l.style.width,l.style.height].concat(i?[i.left,i.top,i.width,i.height]:[]).map(function(e){return e?_xeUtils.default.toNumber(e):""}).join(","),localStorage.setItem(n,_xeUtils.default.toJSONString(u))}},x=function(){return(0,_vue.nextTick)().then(function(){if(!T.zoomLocat){var e=_xeUtils.default.toNumber(k.marginSize),t=C(),o=(0,_dom.getDomNode)(),n=o.visibleHeight,i=o.visibleWidth;T.zoomLocat={top:t.offsetTop,left:t.offsetLeft,width:t.offsetWidth+(t.style.width?0:1),height:t.offsetHeight+(t.style.height?0:1)},Object.assign(t.style,{top:e+"px",left:e+"px",width:i-2*e+"px",height:n-2*e+"px"}),E()}})},n=function(){var e=k.duration,u=k.remember,i=k.showFooter,t=T.inited,o=T.visible,n=L.value;return t||(T.inited=!0),o||(u||l(),T.visible=!0,T.contentVisible=!1,c(),allActivedModals.push(M),setTimeout(function(){T.contentVisible=!0,(0,_vue.nextTick)(function(){if(i){var e=s.value,t=r.value,o=e||t;o&&o.focus()}var n={type:""};a("update:modelValue",!0),z.dispatchEvent("show",n)})},10),n?(-1===msgQueue.indexOf(M)&&msgQueue.push(M),f(),-1!==e&&setTimeout(function(){return m("close")},_xeUtils.default.toNumber(e))):(0,_vue.nextTick)(function(){var e,t,o,n,i=k.fullscreen,l=T.firstOpen;u&&l||d().then(function(){setTimeout(function(){return d()},20)}),l||(T.firstOpen=!0,e=k.id,t=k.remember,o=k.storage,n=k.storageKey,e&&t&&o&&_(n)[e]?function(){var e=k.id,t=k.remember,o=k.storage,n=k.storageKey;if(e&&t&&o){var i=_(n)[e];if(i){var l=C(),u=i.split(","),a=u[0],s=u[1],r=u[2],c=u[3],d=u[4],f=u[5],m=u[6],v=u[7];a&&(l.style.left=a+"px"),s&&(l.style.top=s+"px"),r&&(l.style.width=r+"px"),c&&(l.style.height=c+"px"),d&&f&&(T.zoomLocat={left:d,top:f,width:m,height:v})}}}():i&&(0,_vue.nextTick)(function(){return x()}))})),(0,_vue.nextTick)()},U=function(e){var t=O.value;if(k.maskClosable&&e.target===t){m("mask")}},i=function(e){if((0,_event.hasEventKey)(e,_event.EVENT_KEYS.ESCAPE)){var t=_xeUtils.default.max(allActivedModals,function(e){return e.reactData.modalZindex});t&&setTimeout(function(){t===M&&t.props.escClosable&&m("exit")},10)}},g=function(){return!!T.zoomLocat},b=function(){return(0,_vue.nextTick)().then(function(){var e=T.zoomLocat;if(e){var t=C();T.zoomLocat=null,Object.assign(t.style,{top:e.top+"px",left:e.left+"px",width:e.width+"px",height:e.height+"px"}),E()}})},y=function(){return T.zoomLocat?b().then(function(){return g()}):x().then(function(){return g()})},w=function(e){var t={type:T.zoomLocat?"revert":"max"};return y().then(function(){z.dispatchEvent("zoom",t,e)})},D=function(){var t=T.modalZindex;allActivedModals.some(function(e){return e.reactData.visible&&e.reactData.modalZindex>t})&&c()},H=function(e){var t=k.remember,o=k.storage,n=T.zoomLocat,r=_xeUtils.default.toNumber(k.marginSize),c=C();if(!n&&0===e.button&&!(0,_dom.getEventTargetNode)(e,c,"trigger--btn").flag){e.preventDefault();var i=document.onmousemove,l=document.onmouseup,d=e.clientX-c.offsetLeft,f=e.clientY-c.offsetTop,u=(0,_dom.getDomNode)(),m=u.visibleHeight,v=u.visibleWidth;document.onmousemove=function(e){e.preventDefault();var t=c.offsetWidth,o=c.offsetHeight,n=r,i=v-t-r-1,l=r,u=m-o-r-1,a=e.clientX-d,s=e.clientY-f;i<a&&(a=i),a<n&&(a=n),u<s&&(s=u),s<l&&(s=l),c.style.left=a+"px",c.style.top=s+"px"},document.onmouseup=function(){document.onmousemove=i,document.onmouseup=l,t&&o&&(0,_vue.nextTick)(function(){E()})}}},V=function(e){e.preventDefault();var l=k.remember,u=k.storage,t=(0,_dom.getDomNode)(),a=t.visibleHeight,s=t.visibleWidth,r=_xeUtils.default.toNumber(k.marginSize),c=e.target.getAttribute("type"),d=_xeUtils.default.toNumber(k.minWidth),f=_xeUtils.default.toNumber(k.minHeight),m=s,v=a,p=C(),o=document.onmousemove,n=document.onmouseup,h=p.clientWidth,_=p.clientHeight,x=e.clientX,g=e.clientY,b=p.offsetTop,y=p.offsetLeft,w={type:"resize"};document.onmousemove=function(e){var t,o,n,i;switch(e.preventDefault(),c){case"wl":n=(t=x-e.clientX)+h,r<y-t&&d<n&&(p.style.width=(n<m?n:m)+"px",p.style.left=y-t+"px");break;case"swst":t=x-e.clientX,o=g-e.clientY,n=t+h,i=o+_,r<y-t&&d<n&&(p.style.width=(n<m?n:m)+"px",p.style.left=y-t+"px"),r<b-o&&f<i&&(p.style.height=(i<v?i:v)+"px",p.style.top=b-o+"px");break;case"swlb":t=x-e.clientX,o=e.clientY-g,n=t+h,i=o+_,r<y-t&&d<n&&(p.style.width=(n<m?n:m)+"px",p.style.left=y-t+"px"),b+i+r<a&&f<i&&(p.style.height=(i<v?i:v)+"px");break;case"st":o=g-e.clientY,i=_+o,r<b-o&&f<i&&(p.style.height=(i<v?i:v)+"px",p.style.top=b-o+"px");break;case"wr":t=e.clientX-x,y+(n=t+h)+r<s&&d<n&&(p.style.width=(n<m?n:m)+"px");break;case"sest":t=e.clientX-x,i=(o=g-e.clientY)+_,y+(n=t+h)+r<s&&d<n&&(p.style.width=(n<m?n:m)+"px"),r<b-o&&f<i&&(p.style.height=(i<v?i:v)+"px",p.style.top=b-o+"px");break;case"selb":t=e.clientX-x,i=(o=e.clientY-g)+_,y+(n=t+h)+r<s&&d<n&&(p.style.width=(n<m?n:m)+"px"),b+i+r<a&&f<i&&(p.style.height=(i<v?i:v)+"px");break;case"sb":o=e.clientY-g,b+(i=o+_)+r<a&&f<i&&(p.style.height=(i<v?i:v)+"px")}p.className=p.className.replace(/\s?is--drag/,"")+" is--drag",l&&u&&E(),z.dispatchEvent("zoom",w,e)},document.onmouseup=function(){T.zoomLocat=null,document.onmousemove=o,document.onmouseup=n,setTimeout(function(){p.className=p.className.replace(/\s?is--drag/,"")},50)}},Z=function(){var e,t,o,n,i,l,u,a,s=k.slots,r=void 0===s?{}:s,c=k.showZoom,d=k.draggable,f=L.value,m=N.header||r.header,v=[];if(k.showHeader){var p={};d&&(p.onMousedown=H),c&&k.dblclickZoom&&"modal"===k.type&&(p.onDblclick=w),v.push((0,_vue.h)("div",__assign({class:["vxe-modal--header",{"is--drag":d,"is--ellipsis":!f&&k.showTitleOverflow}]},p),m?!T.inited||k.destroyOnClose&&!T.visible?[]:m({$modal:M}):(e=k.slots,t=void 0===e?{}:e,o=k.showClose,n=k.showZoom,i=k.title,l=T.zoomLocat,u=N.title||t.title,a=u?u({$modal:M}):[(0,_vue.h)("span",{class:"vxe-modal--title"},i?(0,_utils.getFuncText)(i):_conf.default.i18n("vxe.alert.title"))],n&&a.push((0,_vue.h)("i",{class:["vxe-modal--zoom-btn","trigger--btn",l?_conf.default.icon.MODAL_ZOOM_OUT:_conf.default.icon.MODAL_ZOOM_IN],title:_conf.default.i18n("vxe.modal.zoom"+(l?"Out":"In")),onClick:w})),o&&a.push((0,_vue.h)("i",{class:["vxe-modal--close-btn","trigger--btn",_conf.default.icon.MODAL_CLOSE],title:_conf.default.i18n("vxe.modal.close"),onClick:h})),a)))}return v},q=function(){var e,t=k.slots,o=void 0===t?{}:t,n=L.value,i=N.footer||o.footer,l=[];return k.showFooter&&l.push((0,_vue.h)("div",{class:"vxe-modal--footer"},i?!T.inited||k.destroyOnClose&&!T.visible?[]:i({$modal:M}):(e=[],"confirm"===k.type&&e.push((0,_vue.h)(_button.default,{ref:r,content:k.cancelButtonText||_conf.default.i18n("vxe.button.cancel"),onClick:p})),e.push((0,_vue.h)(_button.default,{ref:s,status:"primary",content:k.confirmButtonText||_conf.default.i18n("vxe.button.confirm"),onClick:v})),e))),!n&&k.resize&&l.push((0,_vue.h)("span",{class:"vxe-modal--resize"},["wl","wr","swst","sest","st","swlb","selb","sb"].map(function(e){return(0,_vue.h)("span",{class:e+"-resize",type:e,onMousedown:V})}))),l};z={dispatchEvent:function(e,t,o){a(e,Object.assign({$modal:M,$event:o},t))},open:n,close:function(){return m("close")},getBox:C,getPosition:function(){if(!L.value){var e=C();if(e)return{top:e.offsetTop,left:e.offsetLeft}}return null},setPosition:function(e,t){if(!L.value){var o=C();_xeUtils.default.isNumber(e)&&(o.style.top=e+"px"),_xeUtils.default.isNumber(t)&&(o.style.left=t+"px")}return(0,_vue.nextTick)()},isMaximized:g,zoom:y,maximize:x,revert:b},Object.assign(M,z),(0,_vue.watch)(function(){return k.width},l),(0,_vue.watch)(function(){return k.height},l),(0,_vue.watch)(function(){return k.modelValue},function(e){e?n():m("model")}),(0,_vue.onMounted)(function(){(0,_vue.nextTick)(function(){k.storage&&!k.id&&(0,_utils.errLog)("vxe.error.reqProp",["modal.id"]),k.modelValue&&n(),l()}),k.escClosable&&_event.GlobalEvent.on(M,"keydown",i)}),(0,_vue.onUnmounted)(function(){_event.GlobalEvent.off(M,"keydown"),u()});return M.renderVN=function(){var e,t,o,n,i,l,u,a,s,r=k.className,c=k.type,d=k.animat,f=k.loading,m=k.status,v=k.lockScroll,p=k.lockView,h=k.mask,_=k.resize,x=T.inited,g=T.zoomLocat,b=T.modalTop,y=T.contentVisible,w=T.visible,z=S.value;return(0,_vue.h)(_vue.Teleport,{to:"body",disabled:!k.transfer||!x},[(0,_vue.h)("div",{ref:O,class:["vxe-modal--wrapper","type--"+c,r||"",(e={},e["size--"+z]=z,e["status--"+m]=m,e["is--animat"]=d,e["lock--scroll"]=v,e["lock--view"]=p,e["is--resize"]=_,e["is--mask"]=h,e["is--maximize"]=g,e["is--visible"]=y,e["is--active"]=w,e["is--loading"]=f,e)],style:{zIndex:T.modalZindex,top:b?b+"px":null},onClick:U},[(0,_vue.h)("div",{ref:B,class:"vxe-modal--box",onMousedown:D},Z().concat((t=k.slots,o=void 0===t?{}:t,n=k.status,i=k.message,l=k.content||i,u=L.value,a=N.default||o.default,s=[],n&&s.push((0,_vue.h)("div",{class:"vxe-modal--status-wrapper"},[(0,_vue.h)("i",{class:["vxe-modal--status-icon",k.iconStatus||_conf.default.icon[("MODAL_"+n).toLocaleUpperCase()]]})])),s.push((0,_vue.h)("div",{class:"vxe-modal--content"},a?!T.inited||k.destroyOnClose&&!T.visible?[]:a({$modal:M}):(0,_utils.getFuncText)(l))),u||s.push((0,_vue.h)("div",{class:["vxe-loading",{"is--visible":k.loading}]},[(0,_vue.h)("div",{class:"vxe-loading--spinner"})])),[(0,_vue.h)("div",{class:"vxe-modal--body"},s)]),q()))])])},M},render:function(){return this.renderVN()}});exports.default=_default2;