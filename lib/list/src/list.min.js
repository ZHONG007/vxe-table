"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_size=require("../../hooks/size"),_resize=require("../../tools/resize"),_dom=require("../../tools/dom"),_event=require("../../tools/event");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default2=(0,_vue.defineComponent)({name:"VxeList",props:{data:Array,height:[Number,String],maxHeight:[Number,String],loading:Boolean,className:[String,Function],size:{type:String,default:function(){return _conf.default.list.size||_conf.default.size}},autoResize:{type:Boolean,default:function(){return _conf.default.list.autoResize}},syncResize:[Boolean,String,Number],scrollY:Object},emits:["scroll"],setup:function(s,e){var t,u=e.slots,l=e.emit,r=_xeUtils.default.uniqueId(),c=(0,_size.useSize)(s),g=(0,_vue.reactive)({scrollYLoad:!1,bodyHeight:0,rowHeight:0,topSpaceHeight:0,items:[]}),f=(0,_vue.ref)(),d=(0,_vue.ref)(),v=(0,_vue.ref)(),p={fullData:[],lastScrollLeft:0,lastScrollTop:0,scrollYStore:{startIndex:0,endIndex:0,visibleSize:0,offsetSize:0,rowHeight:0}},i={refElem:f},h={xID:r,props:s,context:e,reactData:g,internalData:p,getRefMaps:function(){return i}},m={},x=(0,_vue.computed)(function(){return Object.assign({},_conf.default.list.scrollY,s.scrollY)}),_=(0,_vue.computed)(function(){var e=s.height,t=s.maxHeight,r={};return e?r.height=""+(isNaN(e)?e:e+"px"):t&&(r.height="auto",r.maxHeight=""+(isNaN(t)?t:t+"px")),r}),S=function(){var e=g.scrollYLoad,t=p.scrollYStore,r=p.fullData;g.bodyHeight=e?r.length*t.rowHeight:0,g.topSpaceHeight=e?Math.max(t.startIndex*t.rowHeight,0):0},n=function(){var e=g.scrollYLoad,t=p.fullData,r=p.scrollYStore;return g.items=e?t.slice(r.startIndex,r.endIndex):t.slice(0),(0,_vue.nextTick)()},z=function(){n(),S()},o=function(){return(0,_vue.nextTick)().then(function(){var e,t=g.scrollYLoad,r=p.scrollYStore,l=v.value,i=x.value,n=0;if(l&&(i.sItem&&(e=l.querySelector(i.sItem)),e||(e=l.children[0])),e&&(n=e.offsetHeight),n=Math.max(20,n),r.rowHeight=n,t){var o=d.value,a=Math.max(8,Math.ceil(o.clientHeight/n)),s=i.oSize?_xeUtils.default.toNumber(i.oSize):_dom.browse.edge?10:0;r.offsetSize=s,r.visibleSize=a,r.endIndex=Math.max(r.startIndex,a+s,r.endIndex),z()}else S();g.rowHeight=n})},a=function(){var e=d.value;return e&&(e.scrollTop=0),(0,_vue.nextTick)()},b=function(e,t){var r=d.value;return _xeUtils.default.isNumber(e)&&(r.scrollLeft=e),_xeUtils.default.isNumber(t)&&(r.scrollTop=t),g.scrollYLoad?new Promise(function(e){return setTimeout(function(){return e((0,_vue.nextTick)())},50)}):(0,_vue.nextTick)()},T=function(){var e=p.lastScrollLeft,t=p.lastScrollTop;return a().then(function(){if(e||t)return p.lastScrollLeft=0,p.lastScrollTop=0,b(e,t)})},H=function(){var e=f.value;return e.clientWidth&&e.clientHeight?o():Promise.resolve()},I=function(e){var t,r,l,i,n,o,a,s,u,c,f,d=e.target,v=d.scrollTop,h=d.scrollLeft,x=h!==p.lastScrollLeft,_=v!==p.lastScrollTop;p.lastScrollTop=v,p.lastScrollLeft=h,g.scrollYLoad&&(t=e,r=p.scrollYStore,l=r.startIndex,i=r.endIndex,n=r.visibleSize,o=r.offsetSize,a=r.rowHeight,s=t.target.scrollTop,u=Math.floor(s/a),c=Math.max(0,u-1-o),f=u+n+o,(u<=l||i-n-1<=u)&&(l===c&&i===f||(r.startIndex=c,r.endIndex=f,z()))),m.dispatchEvent("scroll",{scrollLeft:h,scrollTop:v,isX:x,isY:_},e)};m={dispatchEvent:function(e,t,r){l(e,Object.assign({$list:h,$event:r},t))},loadData:function(e){var t=p.scrollYStore,r=x.value,l=e||[];return Object.assign(t,{startIndex:0,endIndex:1,visibleSize:0}),p.fullData=l,g.scrollYLoad=!!r.enabled&&-1<r.gt&&r.gt<=l.length,n(),o().then(function(){T()})},reloadData:function(e){return a(),m.loadData(e)},recalculate:H,scrollTo:b,refreshScroll:T,clearScroll:a},Object.assign(h,m),(0,_vue.watch)(function(){return s.data},function(e){m.loadData(e||[])}),(0,_vue.watch)(function(){return s.syncResize},function(e){e&&(H(),(0,_vue.nextTick)(function(){return setTimeout(function(){return H()})}))}),(0,_vue.nextTick)(function(){if(_event.GlobalEvent.on(h,"resize",function(){H()}),s.autoResize){var e=f.value;(t=(0,_resize.createResizeEvent)(function(){return H()})).observe(e)}m.loadData(s.data||[])}),(0,_vue.onUnmounted)(function(){t&&t.disconnect(),_event.GlobalEvent.off(h,"resize")});return h.renderVN=function(){var e,t=s.className,r=s.loading,l=g.bodyHeight,i=g.topSpaceHeight,n=g.items,o=c.value,a=_.value;return(0,_vue.h)("div",{ref:f,class:["vxe-list",t?_xeUtils.default.isFunction(t)?t({$list:h}):t:"",(e={},e["size--"+o]=o,e["is--loading"]=r,e)]},[(0,_vue.h)("div",{ref:d,class:"vxe-list--virtual-wrapper",style:a,onScroll:I},[(0,_vue.h)("div",{class:"vxe-list--y-space",style:{height:l?l+"px":""}}),(0,_vue.h)("div",{ref:v,class:"vxe-list--body",style:{marginTop:i?i+"px":""}},u.default?u.default({items:n,$list:h}):[])]),(0,_vue.h)("div",{class:["vxe-list--loading vxe-loading",{"is--visible":r}]},[(0,_vue.h)("div",{class:"vxe-loading--spinner"})])])},h},render:function(){return this.renderVN()}});exports.default=_default2;