"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_dom=require("../../tools/dom");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function getTargetOffset(e,t){var o=0,l=0,n=!_dom.browse.firefox&&(0,_dom.hasClass)(e,"vxe-checkbox--label");if(n){var r=getComputedStyle(e);o-=_xeUtils.default.toNumber(r.paddingTop),l-=_xeUtils.default.toNumber(r.paddingLeft)}for(;e&&e!==t;)if(o+=e.offsetTop,l+=e.offsetLeft,e=e.offsetParent,n){var a=getComputedStyle(e);o-=_xeUtils.default.toNumber(a.paddingTop),l-=_xeUtils.default.toNumber(a.paddingLeft)}return{offsetTop:o,offsetLeft:l}}var tableKeyboardHook={setupTable:function(y){var m=y.props,k=y.reactData,H=y.internalData,E=y.getRefMaps().refElem,e=y.getComputeMaps(),v=e.computeEditOpts,c=e.computeCheckboxOpts,i=e.computeMouseOpts,g=e.computeTreeOpts;var s=function(e,s){var t=s.column,o=s.cell;if("checkbox"===t.type){var l=E.value,n=H.elemStore,d=e.clientX,f=e.clientY,g=n[(t.fixed||"main")+"-body-wrapper"]||n["main-body-wrapper"],m=g.querySelector(".vxe-table--checkbox-range"),r=document.onmousemove,a=document.onmouseup,v=o.parentNode,h=y.getCheckboxRecords(),p=[],u=getTargetOffset(e.target,g),x=u.offsetTop+e.offsetY,w=u.offsetLeft+e.offsetX,b=g.scrollTop,c=v.offsetHeight,i=null,T=!1,C=1,R=function(e,t){y.dispatchEvent("checkbox-range-"+e,{records:y.getCheckboxRecords(),reserves:y.getCheckboxReserveRecords()},t)},_=function(e){var t=e.clientX,o=e.clientY,l=t-d,n=o-f+(g.scrollTop-b),r=Math.abs(n),a=Math.abs(l),u=x,c=w;n<1?(u+=n)<1&&(u=1,r=x):r=Math.min(r,g.scrollHeight-x-1),l<1?(c+=l,w<a&&(c=1,a=w)):a=Math.min(a,g.clientWidth-w-1),m.style.height=r+"px",m.style.width=a+"px",m.style.left=c+"px",m.style.top=u+"px",m.style.display="block";var i=function(e,t,o){var l=0,n=[],r=0<o,a=0<o?o:Math.abs(o)+t.offsetHeight,u=k.scrollYLoad,c=H.afterFullData,i=H.scrollYStore;if(u){var s=y.getVTRowIndex(e.row);n=r?c.slice(s,s+Math.ceil(a/i.rowHeight)):c.slice(s-Math.floor(a/i.rowHeight)+1,s+1)}else for(var d=r?"next":"previous";t&&l<a;){var f=y.getRowNode(t);f&&(n.push(f.item),l+=t.offsetHeight,t=t[d+"ElementSibling"])}return n}(s,v,n<1?-r:r);10<r&&i.length!==p.length&&(p=i,e.ctrlKey?i.forEach(function(e){y.handleSelectRow({row:e},-1===h.indexOf(e))}):(y.setAllCheckboxRow(!1),y.setCheckboxRow(i,!0)),R("change",e))},I=function(){clearTimeout(i),i=null},M=function r(a){I(),i=setTimeout(function(){if(i){var e=g.scrollLeft,t=g.scrollTop,o=g.clientHeight,l=g.scrollHeight,n=Math.ceil(50*C/c);T?t+o<l?(y.scrollTo(e,t+n),r(a),_(a)):I():t?(y.scrollTo(e,t-n),r(a),_(a)):I()}},50)};(0,_dom.addClass)(l,"drag--range"),document.onmousemove=function(e){e.preventDefault(),e.stopPropagation();var t=e.clientY,o=(0,_dom.getAbsolutePos)(g).boundingTop;t<o?(T=!1,C=o-t,i||M(e)):t>o+g.clientHeight?(T=!0,C=t-o-g.clientHeight,i||M(e)):i&&I(),_(e)},document.onmouseup=function(e){I(),(0,_dom.removeClass)(l,"drag--range"),m.removeAttribute("style"),document.onmousemove=r,document.onmouseup=a,R("end",e)},R("start",e)}};return{moveTabSelected:function(e,t,o){var l,n,r,a=m.editConfig,u=H.afterFullData,c=H.visibleColumn,i=v.value,s=Object.assign({},e),d=y.getVTRowIndex(s.row),f=y.getVTColumnIndex(s.column);o.preventDefault(),t?f<=0?0<d&&(l=u[n=d-1],r=c.length-1):r=f-1:f>=c.length-1?d<u.length-1&&(l=u[n=d+1],r=0):r=f+1;var g=c[r];g&&(l?(s.rowIndex=n,s.row=l):s.rowIndex=d,s.columnIndex=r,s.column=g,s.cell=y.getCell(s.row,s.column),a?"click"!==i.trigger&&"dblclick"!==i.trigger||("row"===i.mode?y.handleActived(s,o):y.scrollToRow(s.row,s.column).then(function(){return y.handleSelected(s,o)})):y.scrollToRow(s.row,s.column).then(function(){return y.handleSelected(s,o)}))},moveCurrentRow:function(e,t,o){var l,n=m.treeConfig,r=k.currentRow,a=H.afterFullData,u=g.value;if(o.preventDefault(),r)if(n){var c=_xeUtils.default.findTree(a,function(e){return e===r},u),i=c.index,s=c.items;e&&0<i?l=s[i-1]:t&&i<s.length-1&&(l=s[i+1])}else{var d=y.getVTRowIndex(r);e&&0<d?l=a[d-1]:t&&d<a.length-1&&(l=a[d+1])}else l=a[0];if(l){var f={$table:y,row:l,rowIndex:y.getRowIndex(l),$rowIndex:y.getVMRowIndex(l)};y.scrollToRow(l).then(function(){return y.triggerCurrentRowEvent(o,f)})}},moveSelected:function(e,t,o,l,n,r){var a=H.afterFullData,u=H.visibleColumn,c=Object.assign({},e),i=y.getVTRowIndex(c.row),s=y.getVTColumnIndex(c.column);r.preventDefault(),o&&0<i?(c.rowIndex=i-1,c.row=a[c.rowIndex]):n&&i<a.length-1?(c.rowIndex=i+1,c.row=a[c.rowIndex]):t&&s?(c.columnIndex=s-1,c.column=u[c.columnIndex]):l&&s<u.length-1&&(c.columnIndex=s+1,c.column=u[c.columnIndex]),y.scrollToRow(c.row,c.column).then(function(){c.cell=y.getCell(c.row,c.column),y.handleSelected(c,r)})},triggerHeaderCellMousedownEvent:function(e,t){var o=m.mouseConfig,l=i.value;if(o&&l.area&&y.handleHeaderCellAreaEvent){var n=e.currentTarget,r=(0,_dom.getEventTargetNode)(e,n,"vxe-cell--sort").flag,a=(0,_dom.getEventTargetNode)(e,n,"vxe-cell--filter").flag;y.handleHeaderCellAreaEvent(e,Object.assign({cell:n,triggerSort:r,triggerFilter:a},t))}y.focus(),y.closeMenu&&y.closeMenu()},triggerCellMousedownEvent:function(e,t){var o=e.currentTarget;t.cell=o,function(e,t){var o=m.editConfig,l=m.checkboxConfig,n=m.mouseConfig,r=c.value,a=i.value,u=v.value;if(n&&a.area&&y.handleCellAreaEvent)return y.handleCellAreaEvent(e,t);l&&r.range&&s(e,t),n&&a.selected&&(o&&"cell"!==u.mode||y.handleSelected(t,e))}(e,t),y.focus(),y.closeFilter(),y.closeMenu&&y.closeMenu()}}}},_default=tableKeyboardHook;exports.default=_default;